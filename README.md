# Форма для подачи записки

Для подачи поминовении (записки) и принятия пожертвования через ваше приложение, необходимо подать заявку на support@valaam.ru

После утверждения заявки, вы получите ключ для доступа к сервису отправки форм записок.

## Форма для отправки записки на сервер

Для подачи  записки нужно отправить POST запрос по адресу: `https://valaam.ru/payments/form-rites.php`

Внешний вид формы на Вашем сайте на Ваше усмотрение. Конфигурационные данные: https://valaam.ru/phonegap/rites-config

### Параметры запроса:

- **rite** - идентификатор требы (обязательное поле); возможные значения: `ritesConfig['rites'][...]['id']`
- **names** - имена в записке (обязательное поле) - не более `ritesConfig['maxNames']`, каждое на отдельной строке, пояснение перед имененем (если есть) отделено одним пробелом, только буквы без учёта регистра [a-zа-яё]
- **donate** - сумма пожертвования (обязательное поле) - рекомендованная сумма на одно имя `ritesConfig['rites'][...]['price']`
- **payment** - платёжная система (обязательное поле) - символый код `ritesConfig['payments']['code']`
- **email** - электронный адес пользователя
- **valaam_key** - ключ, выданный Вам, для доступа к сервису (обязательное поле)
- **valaam_debug** - любое значение - для тестирования (записка в базе не создаётся)

### Параметры ответа:

Результат: данные в JSON формате

- **status** - результат: статус обратки запроса; возможные значения: `succeeded` - запрос принят успешно; `error` - при обработке обнаружены ошибки. Если ошибки касаются передаваемых полей, то в ответе будет параметр с сответствующим описанием ошибки для конкретного поля.
 
В случае успешного прохождения запроса, остальные поля зависят от способа принятия пожертвования. 
 
Адрес возврата к вашей форме после оплаты - в процессе разработки. 

Для пожертвования через Яндекс.Кассу (мы её используем) описание результата можно посмотреть на https://kassa.yandex.ru/docs/checkout-api/#ob-ekt-platezha

Ниже указан способ  принятия пожертвования для ApplePay.  

### Пример формы отправки запроса:

```html
<form method="post" action="https://valaam.ru/payments/form-rites.php">
	<select name="rite">
		<optgroup label="О здравии"></optgroup>
		<option value="111900">О здравии - Проскомидия (1 день)</option>
		<option value="7160" selected="">О здравии - Проскомидия, сорокоуст (40 дней)</option>
		<option value="7164">О здравии - Проскомидия (1 год)</option>
		<option value="7162">О здравии - Неусыпаемая Псалтирь (1 год)</option>
		<option value="109064">О здравии - Молебен пред иконой "Валаамская" (1 день)</option>
		<option value="109770">О здравии - Молебен пред иконой "Всецарица" (1 день)</option>
		<option value="109771">О здравии - Молебен прпп. Сергию и Герману (1 день)</option>
		<option value="111904">О здравии - Молебен прп. Антипе Валаамскому (1 день)</option>
		<optgroup label="О упокоении"></optgroup>
		<option value="111901">О упокоении - Проскомидия (1 день)</option>
		<option value="7161">О упокоении - Проскомидия, сорокоуст (40 дней)</option>
		<option value="7165">О упокоении - Проскомидия (1 год)</option>
		<option value="7163">О упокоении - Неусыпаемая Псалтирь (1 год)</option>
		<option value="109776">О упокоении - Панихида (1 день)</option>
	</select>
	<input type="hidden" name="names" value="Иоанна\nИулии\nСофии">
	<input type="radio" name="payment" value="yandex">
	<input type="radio" name="payment" value="bank_card">
	<input type="radio" name="payment" value="sberbank">
	<input type="radio" name="payment" value="mobile_balance">
	<input type="radio" name="payment" value="tinkoff_bank">
	<input type="radio" name="payment" value="webmoney">
	<input type="radio" name="payment" value="POSTAL">
	<input type="radio" name="payment" value="FORSAZH">
	<input type="radio" name="payment" value="WUNION">
	<input type="radio" name="payment" value="apple_pay">
	<input type="radio" name="payment" value="google_pay">
	<input type="radio" name="payment" value="bitcoin">
	<input type="radio" name="payment" value="cash">
	<input type="email" name="email" value="">
	<input name="valaam_key" value="ваш-ключ-выданный-при-запросе" type="hidden">
	<input name="valaam_debug" value="*" type="hidden">
</form>
```
[Страница формы подачи записок](https://valaam.ru/rites/) для сайта работает на основе этого функционала. Для более подробного ознакомления можно посмотреть исходный код страницы. 

### Способ взаимодействия для ApplePay

Результат запроса от формы подачи записки: данные в JSON формате

- **status** - результат: статус обратки запроса; возможные значения: `succeeded` - запрос принят успешно; `error` - при обработке обнаружены ошибки. Если ошибки касаются передаваемых полей, то в ответе будет параметр с сответствующим описанием ошибки для конкретного поля.
- **payment_id** - идентификатор записки (число)
- **payment_rite** - описание требы (строка)
- **payment_code** - код платёжной системы (строка)
- **payment_summ** - сумма пожертвования (число)
- **payment_data** - масив
	- **id** - иденификатор записки (число),
	- **gid** - данные для статистики (строка),
	- **payment** - идетификатор платёжной системы (число)
	- **hash** - контрольная сумма (строка)
	- **valaam_action** - идентификатор типа пожертвования (строка)

**Инициализации сессии**

- адрес скрипта - `https://valaam.ru/payments/ap-authorizemerchant.php`
- Парамеры: нет
- Результат: данные в JSON формате

**Оплата**

- aдрес скрипта для оплаты - `https://valaam.ru/payments/ap-payment.php`
- Парамеры:
	- vmData - данные, полученные при передачи записки (масив) - передавать без изменений
	- paymentData - данные, полученные от скрипта инициализации сессии - преобразовать в json-строку

- Результат: данные в JSON формате
	- status - результат платежа: succeeded|...
 	- ... данные от платёжной системы, используем Яндекс.Касса
